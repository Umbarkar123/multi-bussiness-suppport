{% extends "layout.html" %}
{% block content %}

<div class="page-header">
    <h1>Call History</h1>
    <p style="color:#9aa4b2">All user call requests received by your system</p>
</div>

<!-- ===== FILTER TABS + SEARCH ===== -->
<div class="top-controls">
    <div class="tabs">
        <button class="tab active" onclick="filterStatus('')">All</button>
        <button class="tab" onclick="filterStatus('PENDING')">Pending</button>
        <button class="tab" onclick="filterStatus('APPROVED')">Approved</button>
        <button class="tab" onclick="filterStatus('REJECTED')">Rejected</button>
    </div>

    <div class="calls-search">
        <input type="text" id="callSearch" placeholder="Search by name or phone...">
    </div>
</div>

<!-- ===== TABLE CARD ===== -->
<div class="card table-card">
    <h2>User Call Requests</h2>

    <table class="styled-table" id="dataTable">
        <thead>
            <tr>
                <th>User</th>
                <th>Phone</th>
                <th>Requested Time</th>
                <th>Status</th>
                <th>Date</th>
                <th style="text-align:right">Actions</th>
            </tr>
        </thead>

        <tbody>
            {% for call in calls %}
            <tr class="{{ call.status }}" onclick="toggleCallDetails('{{call._id}}')" style="cursor: pointer;">
                <td><strong>{{ call.name }}</strong></td>
                <td>{{ call.phone }}</td>
                <td>{{ call.time }}</td>
                <td><span class="status {{ call.status }}">{{ call.status }}</span></td>
                <td>{{ call.createdAt }}</td>
                <td style="text-align:right" onclick="event.stopPropagation();">
                    <a href="/call/{{ call._id }}" class="btn-view">üëÅ View</a>
                </td>
            </tr>

            <!-- Expandable Details Row -->
            <tr id="call-details-{{call._id}}" class="details-row" style="display: none;">
                <td colspan="6">
                    <div class="details-content">
                        <h4>üìã All Form Data</h4>
                        <div class="form-data-grid">
                            {% if call.data %}
                            {% for key, value in call.data.items() %}
                            <div class="data-item">
                                <span class="data-label">{{key}}:</span>
                                <span class="data-value">{{value}}</span>
                            </div>
                            {% endfor %}
                            {% else %}
                            <p style="color: #94a3b8;">No additional form data</p>
                            {% endif %}
                        </div>
                        {% if call.app_name %}
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #1e3a4c;">
                            <span class="data-label">Application:</span>
                            <span class="data-value">{{ call.app_name }}</span>
                        </div>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<style>
    /* ===== SAME SAAS THEME AS DASHBOARD ===== */

    .top-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 6px 0 12px 0;
    }

    /* Tabs */
    .tabs {
        display: flex;
        gap: 10px;
    }

    .tab {
        padding: 8px 14px;
        border-radius: 8px;
        background: linear-gradient(145deg, #0e2230, #0b1720);
        border: 1px solid #1e3a4c;
        color: #cbd5e1;
        cursor: pointer;
        font-size: 13px;
    }

    .tab.active {
        background: #facc15;
        color: #000;
        border: none;
    }

    /* Search */
    .calls-search input {
        width: 260px;
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid #1e3a4c;
        background: linear-gradient(145deg, #0e2230, #0b1720);
        color: #e2e8f0;
        font-size: 13px;
    }

    .calls-search input:focus {
        border: 1px solid #38bdf8;
        outline: none;
    }

    /* ===== CARD SAME AS DASHBOARD BLOCK ===== */
    .table-card {
        margin-top: 10px;
        border-radius: 14px;
        padding: 22px;
        background: linear-gradient(145deg, #0f2532, #0b1720);
        border: 1px solid #1e3a4c;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
    }

    /* ===== TABLE SAME AS USER FORM REQUESTS ===== */
    .styled-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
    }

    .styled-table th {
        background: rgba(255, 255, 255, 0.03);
        color: #94a3b8;
        font-weight: 600;
        font-size: 12px;
        letter-spacing: 0.5px;
    }

    .styled-table th,
    .styled-table td {
        padding: 14px 12px;
        border-bottom: 1px solid #1e3a4c;
        font-size: 13px;
        color: #e2e8f0;
        text-align: left;
        /* Ensure alignment */
    }

    .styled-table tbody tr:hover {
        background: rgba(56, 189, 248, 0.06);
    }

    /* column widths */
    .styled-table th:nth-child(1),
    .styled-table td:nth-child(1) {
        width: 20%;
    }

    .styled-table th:nth-child(2),
    .styled-table td:nth-child(2) {
        width: 18%;
    }

    .styled-table th:nth-child(3),
    .styled-table td:nth-child(3) {
        width: 16%;
    }

    .styled-table th:nth-child(4),
    .styled-table td:nth-child(4) {
        width: 14%;
    }

    .styled-table th:nth-child(5),
    .styled-table td:nth-child(5) {
        width: 20%;
    }

    .styled-table th:nth-child(6),
    .styled-table td:nth-child(6) {
        width: 12%;
        text-align: right;
    }

    /* Expandable Details Styling */
    .details-row {
        background: #0a1219 !important;
    }

    .details-content {
        padding: 20px;
        background: linear-gradient(145deg, #0e2230, #0b1720);
        border-radius: 8px;
        border: 1px solid #1e3a4c;
    }

    .details-content h4 {
        margin: 0 0 16px 0;
        color: #e6edf3;
        font-size: 16px;
    }

    .form-data-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 12px;
    }

    .data-item {
        background: #0b1720;
        padding: 10px 14px;
        border-radius: 6px;
        border: 1px solid #1c3344;
    }

    .data-label {
        display: block;
        font-size: 11px;
        color: #94a3b8;
        text-transform: uppercase;
        margin-bottom: 4px;
        font-weight: 600;
    }

    .data-value {
        display: block;
        font-size: 14px;
        color: #e6edf3;
        font-weight: 500;
    }

    /* STATUS BADGES ‚Äî same colors */
    .status {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
    }

    .status.APPROVED {
        background: #22c55e;
        color: white;
    }

    .status.REJECTED {
        background: #ef4444;
        color: white;
    }
</style>

<script>
    function toggleCallDetails(id) {
        const detailsRow = document.getElementById('call-details-' + id);
        if (detailsRow.style.display === 'none') {
            detailsRow.style.display = 'table-row';
        } else {
            detailsRow.style.display = 'none';
        }
    }

    // Status filter
    function filterStatus(status, event) {
        document.querySelectorAll("#dataTable tbody tr").forEach(row => {
            row.style.display =
                (status === "" || row.className === status) ? "" : "none";
        });

        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        event.target.classList.add("active");
    }

    // Search filter
    document.getElementById("callSearch").addEventListener("keyup", function () {
        let value = this.value.toLowerCase();
        document.querySelectorAll("#dataTable tbody tr").forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(value) ? "" : "none";
        });
    });
</script>

{% endblock %}